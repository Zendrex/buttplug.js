---
title: Transport
description: WebSocket transport, ping management, and reconnection handling
---

WebSocket communication, ping keep-alive, and automatic reconnection.

## WebSocketTransport

Default transport backed by a native WebSocket.

```ts
import { WebSocketTransport, consoleLogger } from "@zendrex/buttplug.js";

const transport = new WebSocketTransport({
  logger: consoleLogger,
});
```

<auto-type-table path="src/transport/connection.ts" name="WebSocketTransportOptions" />

### Methods

#### `connect()`

```ts
connect(url: string): Promise<void>
```

Opens a WebSocket connection. Returns immediately if already connected. Concurrent calls return the same in-flight promise.

```ts
await transport.connect("ws://localhost:12345");
```

<Callout type="error" title="Throws">
  `ConnectionError` if the connection fails or the socket closes during handshake.
</Callout>

#### `disconnect()`

```ts
disconnect(): Promise<void>
```

Closes the active WebSocket connection. No-ops if already disconnected. If a `connect()` is in flight, signals it to abort on open.

#### `send()`

```ts
send(data: string): void
```

Sends a text message over the active WebSocket.

<Callout type="error" title="Throws">
  `ConnectionError` if the WebSocket is not in the OPEN state.
</Callout>

#### `on()`

```ts
on<E extends TransportEventName>(event: E, handler: TransportEvents[E]): void
```

Subscribes a handler for the given transport event.

#### `off()`

```ts
off<E extends TransportEventName>(event: E, handler: TransportEvents[E]): void
```

Removes a previously registered handler.

### Events

<auto-type-table path="src/transport/types.ts" name="TransportEvents" />

```ts
transport.on("open", () => {
  console.log("Connection opened");
});

transport.on("message", (data) => {
  console.log("Received:", data);
});

transport.on("close", (code, reason) => {
  console.log(`Closed: ${code} ${reason}`);
});

transport.on("error", (error) => {
  console.error("Transport error:", error);
});
```

### State

```ts
transport.state; // "disconnected" | "connecting" | "connected"
```

## Transport Interface

Contract for custom transport implementations.

<auto-type-table path="src/transport/types.ts" name="Transport" />

## PingManager

Schedules periodic keep-alive pings and triggers disconnect when the server stops responding.

<Callout title="Note">
  PingManager is used internally by ButtplugClient. You typically do not need to construct it manually.
</Callout>

```ts
import { PingManager } from "@zendrex/buttplug.js";
```

<auto-type-table path="src/transport/ping.ts" name="PingOptions" />

### Behavior

- Ping interval is 60% of the server's `maxPingTime`, clamped to a minimum of 100ms
- Default ping timeout is 5000ms when `maxPingTime` is 0
- Skips pings while a previous ping is still in flight
- Triggers disconnect on timeout errors only. Transient errors are recoverable
- Disable automatic pings with `autoPing: false`

### Methods

#### `start()`

```ts
start(maxPingTime: number): void
```

Starts the periodic ping timer. Stops any previously running timer first. Callers must call `stop()` when the transport disconnects.

#### `stop()`

```ts
stop(): void
```

Stops the ping timer and resets in-flight state.

## ReconnectHandler

Automatic reconnection with exponential backoff. Used internally by `ButtplugClient` when `autoReconnect` is enabled.

```ts
import { ReconnectHandler, ReconnectDefaults } from "@zendrex/buttplug.js";
```

<auto-type-table path="src/transport/reconnect.ts" name="ReconnectOptions" />

### Defaults

<TypeTable type={{
  reconnectDelay: { type: '1000', description: 'Base delay in ms before first reconnect attempt (ReconnectDefaults.DELAY)' },
  maxReconnectDelay: { type: '30000', description: 'Upper bound in ms for exponential backoff (ReconnectDefaults.MAX_DELAY)' },
  maxReconnectAttempts: { type: '10', description: 'Maximum reconnection attempts (ReconnectDefaults.MAX_ATTEMPTS)' },
}} />

### Backoff Formula

```
delay = min(reconnectDelay * 2^min(attempt - 1, 30), maxReconnectDelay)
```

The exponent is capped at 30 to prevent integer overflow.

### Methods

#### `start()`

```ts
start(): void
```

Begins the reconnection sequence. No-ops if already active.

#### `cancel()`

```ts
cancel(): void
```

Cancels reconnection and clears pending timers.

#### `active`

```ts
get active(): boolean
```

Whether a reconnection sequence is in progress.
